# AUDIO Readme
This section describes audioArrays.h and the process that was undertaken to get the audio working


## Author
[Chase E Stewart](https://chasestewart.co) for [Hidden Layer Design](https://hiddenlayerdesign.com)


## Overview
The annoyatron project is configured to use [split PWM output](https://ww1.microchip.com/downloads/en/AppNotes/TB3217-Getting-Started-with-TCA-90003217A.pdf) from its [ATTiny 1606](https://ww1.microchip.com/downloads/en/DeviceDoc/ATtiny806_1606_Data_Sheet_40002029A.pdf) CPU in order to generate audio. Audio is stored as C byte arrays in flash. These are fed to the comparator of the TCA0 clock, which uses its PWM Waveform output to control an audio amplifier IC's input pin, which then goes out to a cheap electronics speaker. There are 3 sounds that are used in the project:
* Siren - A short looping frequency chirp that plays repeatedly as the timer counts down. Stops when the timer runs out or when you cut a wire or wires
* YouWin - The phrase "You Win", played once when you win (cut the right wire before time runs out)
* YouLose - The phrase "You Lose", played once when you lose (cut multiple wires, cut the wrong wire, or time runs out)


### Audio Challenges
There are a number of challenges that stymie an easy solution to the audio problem:

1. The split comparator in the TCA0 that is used for PWM audio is only 8-bit sized. So you must use 8-bit audio.
1. You have literally 16kB of flash to work with. This is rather extreme in terms of resource constraint in this day and age. NOTE this could be alleviated easily enough by adding a memory chip, but the original project this is based on was also similarly constrained.

The space constraint is such that you must squeeze every possible shortcut out of the audio such that it still mostly serves your purposes. This includes shortening, bit crushing, downsampling, filtering, and anything you could imagine. It took a lot of tricks from my ECE background and audio tricks from my studio to result in just a quick and intelligible-enough "you win!", "you lose!", and siren noise. The challenge was interesting enough to me that I felt it merited this write-up 


### Audio Solution
Here are the things I had to do in order to get the audio working such as it does now:

1. First, record "you lose" and "you win" audio under the best circumstances possible (I used a quality microphone and audio interface)
1. These should ideally be somewhere from 0.7 to 1.3 seconds long to make your later editing easier
1. Process it for great clarity including compression, breath control, and EQ
1. Ableton Live has a "Telephone Audio" EQ that mostly just band-passes only 500Hz to 2kHz which was crucial for my eventual solution
1. Export that audio in mono at the lowest bitrate and sample frequency possible in your recording software (I started with 22050Hz, 16-bit audio)
1. Now open the audio in [Audacity](https://www.audacityteam.org/), lower the project rate to 8kHz, run `Tracks->Resample->8kHz` on the whole sample
1. Compress the audio further if necessary using `Effect->Compressor...`; the default settings that come up should be fine unless you understand compression
1. If your audio is longer than 0.7 seconds for either youWin or youLose, you may find the `Effect->Change Tempo...` effect extremely helpful in getting your samples to fit within the 16kB of flash
1. [Export from Audacity in 8 bit](https://forum.audacityteam.org/t/is-there-a-way-to-convert-a-song-into-8-bit/35388) into this folder where [ParseWaveFile.py]() exists
1. Run the parseWaveFile.py Python Helper Script to create header files 
1. Copy the C-structs generated by the Python Helper Script into audioArrays.h, covering the current youWin and youLose structs.
1. Now hit Compile in the project, and hope for no errors related to overrunning the Flash. If the code compiles it will fit properly and work in the device
1. Now test the board in success and failure case, and ensure the samples sound clear and sound like what you want. NOTE The quality just won't be that good, you have 16kB to work with! 
1. I had to slightly pitch up my audio in order to deal with some oversampling in the TCA0 code. You can do this by reopening Audacity and using `Effect->Change Pitch...` somewhere like 10-20%

NOTE: The siren noise is mostly original from the 2009/2010 project. I guess my lab partner and I had solved this one time before, but did not write up the process to fit the audio in the previous CPU last time. 

### Python Script
