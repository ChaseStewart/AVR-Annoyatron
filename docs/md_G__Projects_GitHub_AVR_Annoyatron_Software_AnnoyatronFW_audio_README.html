<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AVR-Annoyatron: AUDIO Readme</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var page_layout=1;</script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="side-nav" class="ui-resizable side-nav-resizable"><!-- do not remove this div, it is closed by doxygen! -->
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">AVR-Annoyatron
   </div>
   <div id="projectbrief">A silly embedded prop recreating an undergraduate Embedded System Design project</div>
  </td>
 </tr>
   <tr><td colspan="2">        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td></tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_G__Projects_GitHub_AVR_Annoyatron_Software_AnnoyatronFW_audio_README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">AUDIO Readme </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This section describes <a class="el" href="audioArrays_8h.html">audioArrays.h</a> and the process that was undertaken to get the audio working</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Author</h1>
<p ><a href="https://chasestewart.co">Chase E Stewart</a> for <a href="https://hiddenlayerdesign.com">Hidden Layer Design</a></p>
<h1><a class="anchor" id="autotoc_md2"></a>
Overview</h1>
<p >The annoyatron project is configured to use <a href="https://ww1.microchip.com/downloads/en/AppNotes/TB3217-Getting-Started-with-TCA-90003217A.pdf">split PWM output</a> from its <a href="https://ww1.microchip.com/downloads/en/DeviceDoc/ATtiny806_1606_Data_Sheet_40002029A.pdf">ATTiny 1606</a> CPU in order to generate audio. Audio is stored as C byte arrays in flash. These are fed to the comparator of the TCA0 clock, which uses its PWM Waveform output to control an audio amplifier IC's input pin, which then goes out to a cheap electronics speaker. There are 3 sounds that are used in the project:</p><ul>
<li>Siren - A short looping frequency chirp that plays repeatedly as the timer counts down. Stops when the timer runs out or when you cut a wire or wires</li>
<li>YouWin - The phrase "You Win", played once when you win (cut the right wire before time runs out)</li>
<li>YouLose - The phrase "You Lose", played once when you lose (cut multiple wires, cut the wrong wire, or time runs out)</li>
</ul>
<h2><a class="anchor" id="autotoc_md3"></a>
Audio Challenges</h2>
<p >There are a number of challenges that stymie an easy solution to the audio problem:</p>
<ol type="1">
<li>The split comparator in the TCA0 that is used for PWM audio is only 8-bit sized. So you must use 8-bit audio.</li>
</ol>
<ol type="1">
<li>You have literally 16kB of flash to work with. This is rather extreme in terms of resource constraint in this day and age. NOTE this could be alleviated easily enough by adding a memory chip, but the original project this is based on was also similarly constrained.</li>
</ol>
<p >The space constraint is such that you must squeeze every possible shortcut out of the audio such that it still mostly serves your purposes. This includes shortening, bit crushing, downsampling, filtering, and anything you could imagine. It took a lot of tricks from my ECE background and audio tricks from my studio to result in just a quick and intelligible-enough "you win!", "you lose!", and siren noise. The challenge was interesting enough to me that I felt it merited this write-up</p>
<h2><a class="anchor" id="autotoc_md4"></a>
Audio Solution</h2>
<p >Here are the things I had to do in order to get the audio working such as it does now:</p>
<ol type="1">
<li>First, record "you lose" and "you win" audio under the best circumstances possible (I used a quality microphone and audio interface)</li>
</ol>
<ol type="1">
<li>These should ideally be somewhere from 0.7 to 1.3 seconds long to make your later editing easier</li>
</ol>
<ol type="1">
<li>Process it for great clarity including compression, breath control, and EQ</li>
</ol>
<ol type="1">
<li>Ableton Live has a "Telephone Audio" EQ that mostly just band-passes only 500Hz to 2kHz which was crucial for my eventual solution</li>
</ol>
<ol type="1">
<li>Export that audio in mono at the lowest bitrate and sample frequency possible in your recording software (I started with 22050Hz, 16-bit audio)</li>
</ol>
<ol type="1">
<li>Now open the audio in <a href="https://www.audacityteam.org/">Audacity</a>, lower the project rate to 8kHz, run <code>Tracks-&gt;Resample-&gt;8kHz</code> on the whole sample</li>
</ol>
<ol type="1">
<li>Compress the audio further if necessary using <code>Effect-&gt;Compressor...</code>; the default settings that come up should be fine unless you understand compression</li>
</ol>
<ol type="1">
<li>If your audio is longer than 0.7 seconds for either youWin or youLose, you may find the <code>Effect-&gt;Change Tempo...</code> effect extremely helpful in getting your samples to fit within the 16kB of flash</li>
</ol>
<ol type="1">
<li><a href="https://forum.audacityteam.org/t/is-there-a-way-to-convert-a-song-into-8-bit/35388">Export from Audacity in 8 bit</a> into this folder where <a href="parseWaveFile.py">ParseWaveFile.py</a> exists</li>
</ol>
<ol type="1">
<li>Run the parseWaveFile.py Python Helper Script to create header files</li>
</ol>
<ol type="1">
<li>Copy the C-structs generated by the Python Helper Script into <a class="el" href="audioArrays_8h.html">audioArrays.h</a>, covering the current youWin and youLose structs.</li>
</ol>
<ol type="1">
<li>Now hit Compile in the project, and hope for no errors related to overrunning the Flash. If the code compiles it will fit properly and work in the device</li>
</ol>
<ol type="1">
<li>Now test the board in success and failure case, and ensure the samples sound clear and sound like what you want. NOTE The quality just won't be that good, you have 16kB to work with!</li>
</ol>
<ol type="1">
<li>I had to slightly pitch up my audio in order to deal with some oversampling in the TCA0 code. You can do this by reopening Audacity and using <code>Effect-&gt;Change Pitch...</code> somewhere like 10-20%</li>
</ol>
<p >NOTE: The siren noise is mostly original from the 2009/2010 project. I guess my lab partner and I had solved this one time before, but did not write up the process to fit the audio in the previous CPU last time.</p>
<h2><a class="anchor" id="autotoc_md5"></a>
Python Script</h2>
<p >The recommended way to use the <a href="parseWaveFile.py">ParseWaveFile.py</a> script is to download the community version of PyCharm, and make a new project in the Software/AnnoyatronFW/audio project. You can use a venv and a python3 interpreter and it should work right out of the box- the <a href="https://docs.python.org/3/library/wave.html">wave library</a> that is used is a standard python library. You can bring .WAV files right into the audio/ folder, and by default your generated headers will be created in the Outputs/ folder- the .gitignore files are set up such that your inputs and outputs won't be accidentally contributed to the repository. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
